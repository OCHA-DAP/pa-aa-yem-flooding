---
title: "09_ECMWF_MARS_"
output: 
    bookdown::html_document2:
        toc: true
        toc_float: true
        toc_depth: 4
date: "2023-04-07"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE, eval = TRUE
)
```


```{r libs}
library(tidyverse)
library(lubridate)
library(sf)
library(leaflet)
library(targets)
library(sysfonts)
library(gghdx)
library(here)
library(zoo)
library(extRemes)
library(data.table)
tar_source()

font_add_google("Source Sans Pro")
showtext::showtext_auto()

# ERA 5
tar_load(era5_w_rolling)

# MARS
tar_load(ecmwf_mars_leads_split_rolled)


# CHIRPS
tar_load(zonal_stats_high_risk_hull)
chirps <- zonal_stats_high_risk_hull %>% 
    map(~.x %>% 
            mutate(date=as_date(date)))
    

```


## Intro/background

In this doc:
- We look at ERA 5 historical precip data.
- Describe how the MARS data has been processed for forecast skill analysis
- calculate return periods for ERA5 historical precip data

## ERA5 Historical Rainfall.

Daily ERA5 historical precipitation was obtained from the `total_precipitation_sum` band of the [ERA5-Land Daily Aggregated - ECMWF Climate Reanalysis]("https://developers.google.com/earth-engine/datasets/catalog/ECMWF_ERA5_LAND_DAILY_RAW"). [ERA5 Daily Aggregates - Latest Climate Reanalysis Produced by ECMWF / Copernicus Climate Change Service]("https://developers.google.com/earth-engine/datasets/catalog/ECMWF_ERA5_DAILY") was also considered, but only had historical data up to `2020-07-09` so was not used.

ERA 5 historical precipitation data (1981-2022) were extracted to the area surrounding the high risk sites in Marib and Hajjah. The daily values in each were aggregated by weighted "mean" based on cell overlap with boundaries. Rolling 3, 5, and 10 day accumulation values were also calculated. The result is in the `era5_w_rolling` target. Displayed here:

```{r}
era5_w_rolling
```

## ECMWF Historical Forecast (MARS)

ECMWF MARS historical precipitation forecasts (2007-2022) were extracted to the area surrounding the high risk sites in Marib and Hajjah. The each raster originally contained 11 bands time steps: 0,1,2,3,4,5,6,7,8,9,10,11. The 0 time-step contained no data so was omitted. time steps 1:11 rep represent days 1-10. After extracting the weighted zonal means to the aoi polygons. The time-steps were converted to dates and split into columns in the target `ecmwf_mars_leads_split_rolled` displayed below. Additionally for each date-leadtime combination the 3,5, and 10 day rolling accumulation window calculations were made in addition to the daily values. **Note:** column `date_forecast_predict` in the target represents the date that is being forecasted, not the date the forecast was made.

```{r}

ecmwf_mars_leads_split_rolled
```


## ECMWF + ERA5

as you can see below the ERA5 & ECMWF MARS data can now easily be combined for skill analysis at different lead times as well as differen't accumulation windows
```{r}
mars_era5_combined <- ecmwf_mars_leads_split_rolled %>% 
    left_join(era5_w_rolling, 
              by =c("governorate_name","date_forecast_predict"="date")
              )
```

Here is single day accumulation with lead-time =1 
```{r}
mars_era5_combined %>% 
    ggplot(aes(x=lead_1_daily,y=era_precip_daily))+
    geom_point()+
    labs(x="ECMWF Forecast - Lead 1 (mm)",
         y="ERA5 Precipitation (mm)",
         title = "ECMWF Forecast vs ERA5 Historical",
         subtitle = "Daily Precipitation Values. Forecast set to a lead-time of 1 day"
         )+
    facet_wrap(~governorate_name)+
    theme_hdx()
```

We see that the correlation looks better when we aggregate to 3 day accumulation windows:
```{r}
mars_era5_combined %>% 
    ggplot(aes(x=lead_1_roll3,y=era_roll3))+
    geom_point()+
    facet_wrap(~governorate_name)+
    labs(x="ECMWF Forecast - Lead 1 (mm)",
         y="ERA5 Precipitation (mm)",
         title = "ECMWF Forecast vs ERA5 Historical",
         subtitle = "3 day rainfall acccumulation values. Forecast set to a lead-time of 1 day"
         )+
    theme_hdx()
```


```{r}

chirps_long <- chirps %>% 
    imap_dfr(\(df,nm){
        df %>% 
           mutate(
               name = paste0("chirps_",nm)
           ) %>% 
            rename(value = mean) %>% 
            select(-median)
    }
    )
chirps_era_long <- bind_rows(
    chirps_long,
    era5_w_rolling %>% 
    pivot_longer(cols = starts_with("era_"))
        
    
)
chirps_era_wide <- chirps_era_long %>% 
    pivot_wider(names_from=name, values_from = value)
```


## CHIRPS Vs ERA5 

### Rainfall scatter plots

```{r}
chirps_era_wide %>% 
    ggplot(aes(x= chirps_precip_daily,y=era_precip_daily))+
    geom_point(alpha=0.2)+
    facet_wrap(~governorate_name)+
    theme_hdx()+
    labs(
        x= "CHIRPS",
        y= "ERA5",
        title= "Daily Precip"
    )
chirps_era_wide %>% 
    ggplot(aes(x= chirps_roll3,y=era_roll3))+
    geom_point(alpha=0.2)+
    facet_wrap(~governorate_name)+
    theme_hdx()+
    labs(
        x= "CHIRPS",
        y= "ERA5",
        title= "3 day rain accumuation"
    )

chirps_era_wide %>% 
    ggplot(aes(x= chirps_roll5,y=era_roll5))+
    geom_point(alpha=0.2)+
    facet_wrap(~governorate_name)+
    theme_hdx()+
        labs(
        x= "CHIRPS",
        y= "ERA5",
        title= "5 day rain accumuation"
    )
chirps_era_wide %>% 
    ggplot(aes(x= chirps_roll10,y=era_roll10))+
    geom_point(alpha=0.2)+
    facet_wrap(~governorate_name)+
    theme_hdx()+
        labs(
        x= "CHIRPS",
        y= "ERA5",
        title= "10 day rain accumuation"
    )

```

## Timeseries Plots
```{r}
chirps_era_long %>%
    filter(str_detect(name,"_daily$")) %>% 
    ggplot(aes(x= date, y= value, color= name, group=name))+
    # ggplot(aes(x= chirps_roll10,y=era_roll10))+
    geom_line(alpha=0.5)+
    facet_wrap(~governorate_name)+
    theme_hdx()+
        labs(
        title= "Daily rain accumuation"
    )
chirps_era_long %>%
    filter(str_detect(name,"_roll3$")) %>% 
    ggplot(aes(x= date, y= value, color= name, group=name))+
    # ggplot(aes(x= chirps_roll10,y=era_roll10))+
    geom_line(alpha=0.5)+
    facet_wrap(~governorate_name)+
    theme_hdx()+
        labs(
        title= "3-day rain accumuation"
    )
chirps_era_long %>%
    filter(str_detect(name,"_roll5$")) %>% 
    ggplot(aes(x= date, y= value, color= name, group=name))+
    geom_line(alpha=0.5)+
    facet_wrap(~governorate_name)+
    theme_hdx()+
        labs(
        title= "5-day rain accumuation"
    )
chirps_era_long %>%
    filter(str_detect(name,"_roll10$")) %>% 
    ggplot(aes(x= date, y= value, color= name, group=name))+
    
    geom_line(alpha=0.5)+
    facet_wrap(~governorate_name)+
    theme_hdx()+
        labs(
        title= "10-day rain accumuation"
    )
```

## Return Periods

This chunk calculates the return period for the ERA data at daily, 3-day, 5-day, and 10-day accumulation levels.

```{r}
era_return_periods_df <- chirps_era_wide %>% 
    split(.$governorate_name) %>% 
    imap_dfr(
        \(df_temp,nm){
            c("era_precip_daily","era_roll3","era_roll5","era_roll10") %>% 
                map(\(precip_temp){
                    return_period_level_tibble(df = df_temp,
                           value = precip_temp,
                           date = "date",rp_year = c(2,3,4,5 )) %>% 
                        mutate(precip_regime= precip_temp,
                               governorate_name=nm)
                }
                ) 
            
        }
    ) 

era_return_periods_df
```

