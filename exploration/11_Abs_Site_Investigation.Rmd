---
title: "Abs Site Investigation"
output: 
    bookdown::html_document2:
        toc: true
        toc_float: true
        toc_depth: 4
date: "2023-05-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  eval = TRUE,
  results="asis"
)
```



```{r libs}
library(tidyverse)
library(lubridate)
library(sf)
library(targets)
library(gghdx)
library(leaflet)
gghdx()
tar_source()

tar_load(cccm_flood_marib_hajjah_impact)
tar_load(adm_sf)
tar_load(high_risk_hulls)
tar_load(cccm_wb)
tar_load(cccm_floodscore_df)
```


Final list of priority sites for field response includes sites only from Hajjah and Marib governorates (adm1), but only 3 districts (adm2)

- Hajjah
    + Abs
- Marib
    + Marib
    + Marib City
    
```{r}

adm2 <- adm_sf$yem_admbnda_adm2_govyem_cso_20191002 %>% 
    select(matches("^adm\\d_[ep]"))


master_db_coords <- cccm_wb$`ML- Flooding Available data` %>% 
    select(
      longitude = available_coordinates_longitude,
      latitude = available_coordinates_latitude, site_id
    ) %>%
    filter(!is.na(longitude), !is.na(latitude))

high_risk_db_sp <- cccm_floodscore_df %>% 
    filter(site_flood_hazard_score == "High Hazard") %>%
    left_join(master_db_coords) %>%
    filter(!is.na(longitude), !is.na(latitude)) %>% 
    st_as_sf(coords=c("longitude","latitude"),crs=4326)

high_risk_db_sp <- high_risk_db_sp %>% 
    st_join(adm2)
```
 
- `high_risk_hulls` - made from all high risk sites with `governorate_name` of `Hajjah` or `Marib` except site_id `YE1712_0643` which was clearly outside
- `gov_hulls` made from all high risk sites falling in the 2 governorates after spatial joining with the admin
- `district_hull` made from all high risk sies falling the the 3 districts (Abs, Marib, Marib City) based on spatial join with admin
 
 
````{r} 
 
 gov_hulls <- c("Hajjah", "Ma'rib") %>%
    map(
      \(gov){
        pts_sf <- high_risk_db_sp %>%
          filter(
            adm1_en == gov,
          ) %>%
          st_as_sf(coords = c("longitude", "latitude"), crs = 4326)
        st_convex_hull(st_union(pts_sf)) %>%
          st_as_sf() %>%
          mutate(governorate_name = gov) %>%
          rename(geometry = x)
      }
    ) %>%
    bind_rows()

 district_hulls <- c("Abs", "Ma'rib") %>%
    map(
      \(district){
        pts_sf <- high_risk_db_sp %>%
          filter(
             str_detect(adm2_en,district) # this will catch Ma'rib and Ma'rib City
            
          ) %>%
          st_as_sf(coords = c("longitude", "latitude"), crs = 4326)
        st_convex_hull(st_union(pts_sf)) %>%
          st_as_sf() %>%
          mutate(dist = district) %>%
          rename(geometry = x)
      }
    ) %>%
    bind_rows()
```


```{r}


sites_joined_adm2 <- cccm_flood_marib_hajjah_impact %>% 
    st_as_sf(coords = c("lon","lat"),crs=4326) %>% 
    st_join(
        adm2
    ) 

abs_high_risk_sites <- sites_joined_adm2 %>% 
    filter(adm2_en=="Abs")
hajjah_high_risk_sites <- sites_joined_adm2 %>% 
    filter(adm1_en=="Hajjah")

marib_high_risk_sites <-  sites_joined_adm2 %>% 
    filter(adm1_en=="Ma'rib")
marib_marib_city_high_risk_sites <-  sites_joined_adm2 %>% 
    filter(adm2_en %in% c("Ma'rib","Ma'rib City"))


# convex
abs_convex <- abs_high_risk_sites%>% 
    st_union() %>% 
    st_convex_hull()

hajjah_convex <- hajjah_high_risk_sites %>% 
    st_union() %>% 
    st_convex_hull()

marib_gov_convex <- marib_high_risk_sites %>% 
    st_union() %>% 
    st_convex_hull()


marib_districts_convex <- marib_marib_city_high_risk_sites %>% 
    st_union() %>% 
    st_convex_hull()
```

```{r}
leaflet() %>% 
    addTiles() %>% 
    addPolygons(data=adm_sf$yem_admbnda_adm1_govyem_cso_20191002,fill=NA,fillColor = NA) %>%
    addPolygons(data= high_risk_hulls,color="purple") %>% 
    addMarkers(data= high_risk_db_sp %>% 
                   filter(governorate_name %in% c("Hajjah","Marib"),
                            site_id != "YE1712_0643")
               )
```

 

```{r}

leaflet() %>% 
    addTiles() %>% 
    addPolygons(data=adm_sf$yem_admbnda_adm1_govyem_cso_20191002,fill=NA,fillColor = NA) %>%
    addPolygons(data=adm_sf$yem_admbnda_adm2_govyem_cso_20191002,color="grey",fill=NA,fillColor = NA) %>% 
    # addPolygons(data= hajjah_convex, color="green") %>% 
    # addPolygons(data= abs_convex, color="red") %>% 
    addPolygons(data= high_risk_hulls,color="purple") %>% 
    addPolygons(data= district_hulls,color="red") %>% 
    addMarkers(data=abs_high_risk_sites)
```
    

```{r}
leaflet() %>% 
    addTiles() %>% 
    addPolygons(data=adm_sf$yem_admbnda_adm1_govyem_cso_20191002,fill=NA,fillColor = NA) %>%
    addPolygons(data=adm_sf$yem_admbnda_adm2_govyem_cso_20191002,color="grey",fill=NA,fillColor = NA) %>% 
    addPolygons(data= high_risk_hulls,color="purple") %>% 
    addPolygons(data= hajjah_convex, color="green") %>% 
    addPolygons(data= abs_convex, color="red") %>% 
    addMarkers(data=abs_high_risk_sites)
```


```{r}
leaflet() %>% 
    addTiles() %>% 
    addPolygons(data=adm_sf$yem_admbnda_adm1_govyem_cso_20191002,fill=NA,fillColor = NA) %>%
    addPolygons(data=adm_sf$yem_admbnda_adm2_govyem_cso_20191002,color="grey",fill=NA,fillColor = NA) %>% 
    addPolygons(data= marib_gov_convex, color="green") %>% 
    addPolygons(data= marib_districts_convex, color="red") %>% # okay marixb makes no difference
    addMarkers(data=marib_marib_city_high_risk_sites)
```    

Therefore let's design:

1. a target for convex hull of Abs high risk sites:
    func:   `gen_district_hulls()` 
    target:`high_risk_district_hulls`
2. a target for chirps extraction of high-risk sites. 
    target chirps: `zonal_stats_high_risk_district_hull`
3. a target for chirps-gefs extraction.

```{r}
tar_load(high_risk_district_hulls)

leaflet() %>% 
    addTiles() %>% 
    addPolygons(data=adm_sf$yem_admbnda_adm1_govyem_cso_20191002,fill=NA,fillColor = NA) %>%
    addPolygons(data=adm_sf$yem_admbnda_adm2_govyem_cso_20191002,color="grey",fill=NA,fillColor = NA) %>% 
    addPolygons(data= marib_gov_convex, color="green") %>%
    addPolygons(data= high_risk_district_hulls, color="red") %>% # okay marixb makes no difference
    addMarkers(data=marib_marib_city_high_risk_sites) %>% 
    addMarkers(data=abs_high_risk_sites)
```

```{r}
library(extRemes)
tar_load(zonal_stats_high_risk_district_hull)
zonal_stats_high_risk_district_hull$roll3 %>% 
    split(.$governorate_name) %>% 
    imap_dfr(\(df_temp,nm){
        # cat(nm,"/n")
        return_period_level_tibble(df =df_temp,
                                   date = "date",
                                   value = "mean",
                                   rp_year = c(2,3,4,5) ) %>% 
            mutate(governorate_name = nm) 
    }
    )
zonal_stats_high_risk_district_hull$roll3 %>% 
    split(.$governorate_name) %>% 
    imap_dfr(\(df_temp,nm){
        # cat(nm,"/n")
        return_period_level_tibble(df =df_temp,
                                   date = "date",
                                   value = "mean",
                                   rp_year = c(2,3,4,5) ) %>% 
            mutate(governorate_name = nm) 
    }
    )
```


